<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Beef AI - Middleman Bridge</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { background: #111; color: #0f0; font-family: monospace; padding: 20px; }
        .log { border-bottom: 1px solid #333; padding: 5px 0; }
        .status { font-weight: bold; color: yellow; }
        .online { color: #0f0; }
        .error { color: #f00; }
    </style>
</head>
<body>
    <h2>BEEF AI - MIDDLEMAN BRIDGE</h2>
    <p>Status: <span id="status" class="status">Initializing...</span></p>
    <div id="logs"></div>

    <script>
        const statusSpan = document.getElementById('status');
        const logsDiv = document.getElementById('logs');
        
        // 1. Host the Peer ID that the Client is looking for
        // Your Client looks for "beef-ai-server", so we use that ID here.
        const peer = new Peer("beef-ai-server");

        function log(msg) {
            const div = document.createElement('div');
            div.className = 'log';
            div.innerText = `> ${msg}`;
            logsDiv.prepend(div);
        }

        peer.on('open', (id) => {
            statusSpan.innerText = "ONLINE (Hosting: " + id + ")";
            statusSpan.classList.add('online');
            log("Bridge is active. Waiting for Client...");
        });

        peer.on('error', (err) => {
            statusSpan.innerText = "ERROR";
            statusSpan.classList.add('error');
            log("PeerJS Error: " + err.type);
        });

        peer.on('connection', (conn) => {
            log("Client connected!");

            conn.on('data', async (userPrompt) => {
                log("Received from Client: " + userPrompt);

                try {
                    // 2. Forward the message to your local server.js
                    log("Forwarding to server.js...");
                    
                    const response = await fetch('http://localhost:3000/ask', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: userPrompt })
                    });

                    const data = await response.json();
                    
                    if (data.reply) {
                        // 3. Send the AI answer back to the Client
                        log("Got answer from server.js. Sending to Client.");
                        conn.send(data.reply); 
                    } else {
                        log("Error from server.js: " + JSON.stringify(data));
                        conn.send("Error: Server didn't return a reply.");
                    }

                } catch (err) {
                    log("Failed to contact server.js: " + err.message);
                    conn.send("Error: Middleman could not reach server.js. Is it running?");
                }
            });

            conn.on('close', () => {
                log("Client disconnected.");
            });
        });
    </script>
</body>
</html>
